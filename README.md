# Fish - 摸鱼阅读器 项目指南

## 项目概述

Fish 是一个轻量级的桌面阅读应用程序，采用 PyQt6 构建。该项目的主要目的是提供一个简洁、高效的浮动窗口阅读器，让用户可以方便地阅读文本文件，并通过键盘快捷键进行导航。

### 核心功能
- **浮动窗口界面**: 创建一个半透明的浮动窗口，显示文本内容
- **键盘导航**: 支持使用方向键（上/下）或 W/S 键来逐行浏览文本内容
- **进度保存**: 自动保存阅读进度，下次打开时从上次位置继续阅读
- **书架管理**: 使用 JSON 文件管理系统保存用户打开的书籍和进度信息
- **跨会话记忆**: 阅读进度信息存储在用户 AppData 目录中，重启应用后信息不丢失
- **行号跳转**: 支持通过 G 键后跟行号跳转到指定位置
- **文本分页**: 自动处理长行文本，将其分割为适合显示的段落
- **窗口置顶**: 窗口始终保持在最前端，便于阅读
- **窗口拖拽**: 支持鼠标拖拽移动窗口位置
- **焦点状态**: 窗口获得焦点时显示蓝色边框，失去焦点时显示绿色边框
- **重新选择书籍**: 支持使用 R 键重新选择要阅读的书籍
- **日志记录**: 记录应用程序运行日志，便于调试和跟踪

### 技术架构
- **编程语言**: Python 3.13+
- **GUI 框架**: PyQt6
- **依赖管理**: 采用 uv 包管理器
- **配置格式**: pyproject.toml
- **数据存储**: JSON 文件 (位于 %APPDATA%/fish/bookshelf.json)
- **日志系统**: Python 内置 logging 模块

## 构建和运行

### 环境要求
- Python 3.13 或更高版本
- uv 包管理器

### 安装和启动
1. 使用 uv 包管理器安装项目依赖：
   ```bash
   uv sync
   ```

2. 运行应用程序：
   ```bash
   uv run fish
   ```
   
   或者直接运行：
   ```bash
   python -m src.fish
   ```

### 开发命令
- **运行应用**: `uv run fish`
- **检查依赖**: `uv lock --check` (确保 uv.lock 与 pyproject.toml 同步)

## 使用说明

### 启动应用
1. 启动应用后会首先检查是否已有打开的书籍
2. 如果没有，则会弹出文件选择对话框供用户选择文本文件 (.txt)
3. 选择文件后，应用会显示一个固定大小的浮动窗口，展示当前行的文本内容
4. 程序退出时自动保存阅读进度

### 控制说明
- **上一行**: 按 Up 方向键或 W 键
- **下一行**: 按 Down 方向键或 S 键
- **跳转到指定行**: 按 G 键，输入行号，然后按 Enter
- **退出应用**: 按 Q 键
- **拖拽窗口**: 鼠标左键点击并拖拽窗口任意位置
- **重新选择书籍**: 按 R 键重新选择要阅读的文本文件

### UI 特性
- 窗口始终置顶，便于阅读
- 无边框设计，界面简洁
- 获得焦点时边框颜色变蓝色，失去焦点时变绿色
- 半透明背景，减少视觉干扰
- 右下角显示当前阅读行号
- 窗口大小固定为 500x75 像素，适合单行内容显示
- 支持窗口拖拽移动

## 开发说明

### 核心组件

#### __main__.py
- 应用程序主入口
- 初始化 QApplication 和 BookManager
- 处理首次启动时的文件选择逻辑
- 创建 FloatingWindow 实例
- 配置日志系统并记录应用运行状态
- 确保应用退出时保存阅读进度

#### floating_window.py
- 实现浮动窗口的 UI 和交互逻辑
- 处理键盘事件和鼠标点击事件
- 更新和显示文本内容
- 管理窗口的焦点状态
- 实现窗口拖拽功能
- 支持行号跳转功能
- 实现窗口始终置顶功能
- 显示当前阅读行号

#### book_manager.py
- 管理用户的书籍和阅读进度
- 提供加载和保存书架数据的方法
- 实现行数统计和内容分页功能
- 提供进度更新和查询接口
- 处理文本内容格式化和行号映射
- 实现智能文本分割算法

### 数据存储
应用数据存储在用户的 AppData 目录中 (`%APPDATA%/fish/bookshelf.json`)，包含:
- 已打开的书籍路径
- 每本书的阅读进度
- 每本书的总行数
- 行号映射关系（实际文件行号与显示行号的映射）

### 代码风格
- 遵循 Python PEP 8 代码风格规范
- 使用类型提示提高代码可读性
- 中英文注释混合，以中文为主
- 使用 Python 内置 logging 模块记录日志

### 关键功能实现

#### 文本分页算法
`book_manager.py` 中的 `_split_line` 方法实现了智能文本分割：
- 按句子分割（以。？！为结束标志）
- 每行最多两个句子
- 在适当位置（标点符号、空格）进行断行
- 处理超长句子的强制分割
- 将行组织成段落（每段最多两行）

#### 进度管理
- 维护实际文件行号与显示行号的映射关系
- 自动保存阅读进度到 JSON 文件
- 支持跨会话的进度恢复
- 实现双向行号映射（实际行号↔显示行号）

#### 窗口管理
- 实现拖拽移动功能
- 保持窗口始终置顶
- 实现焦点状态切换（边框颜色变化）
- 实现窗口大小固定

## 依赖项

项目主要依赖：
- `pyqt6>=6.9.1` - GUI 框架
- `uv-build>=0.9.2` - 构建工具

## 文件结构

```
fish/
├── pyproject.toml          # 项目配置和依赖定义
├── uv.lock                 # 依赖版本锁定文件
├── README.md               # 项目说明文档
├── .gitignore              # Git 忽略文件配置
├── src/
│   └── fish/
│       ├── __init__.py     # 包初始化文件
│       ├── __main__.py     # 应用程序入口点
│       ├── floating_window.py  # 浮动窗口 UI 实现
│       └── book_manager.py     # 书籍管理和进度保存
```

## 日志系统

Fish 应用程序记录运行日志到 `%APPDATA%/fish/log/fish.log`，日志信息包括：
- 应用启动和退出
- 文件选择和加载
- 阅读进度更新
- 错误和警告信息

## 扩展功能

Fish 提供了以下扩展功能：
- 支持重新选择书籍（R键）
- 智能文本分页和格式化
- 行号映射和跳转
- 窗口置顶和拖拽
- 详细的日志记录
- 文件大小限制保护（防止加载过大文件）
